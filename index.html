<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générer des images en local</title>
    <style>
        /* Reset CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #0f0f0f;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            background: #1a1a1a;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            color: #ffffff;
            margin-bottom: 24px;
            font-size: 28px;
            text-align: center;
            border-bottom: 1px solid #333;
            padding-bottom: 16px;
            font-weight: 700;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            border-bottom: 1px solid #333;
            margin-bottom: 24px;
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .tab-button {
            padding: 12px 24px;
            background-color: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-weight: 500;
        }

        .tab-button:hover {
            color: #fff;
            background-color: #2a2a2a;
        }

        .tab-button.active {
            color: #fff;
            border-bottom: 2px solid #7c3aed;
            background-color: #2a2a2a;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 20px;
            background-color: #222;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .tab-content.active {
            display: block;
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
            color: #bbb;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 1px solid #444;
            border-radius: 8px;
            font-size: 14px;
            background-color: #333;
            color: #e0e0e0;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #7c3aed;
            outline: none;
            background-color: #3a3a3a;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group button {
            background-color: #7c3aed;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-weight: 500;
        }

        .form-group button:hover {
            background-color: #6d28d9;
            transform: translateY(-1px);
        }

        .form-group button:active {
            transform: translateY(1px);
        }

        .form-group button:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
        }

        /* Card Style Sections */
        .card {
            background-color: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid #333;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #444;
            color: #fff;
            display: flex;
            align-items: center;
        }

        .card-header::before {
            content: "";
            display: inline-block;
            width: 4px;
            height: 18px;
            background-color: #7c3aed;
            margin-right: 10px;
            border-radius: 2px;
        }

        /* Status and Result Boxes */
        #result {
            margin-top: 24px;
            padding: 20px;
            background-color: #2a2a2a;
            border-radius: 8px;
            font-size: 14px;
            color: #e0e0e0;
        }

        .status-box {
            margin-top: 24px;
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            display: none;
        }

        .status-box.success {
            background-color: rgba(124, 58, 237, 0.15);
            color: #a78bfa;
            border: 1px solid rgba(124, 58, 237, 0.3);
        }

        .status-box.error {
            background-color: rgba(220, 53, 69, 0.15);
            color: #f87171;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        /* LoRA Section */
        .lora-group {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        .lora-group button {
            background-color: #7c3aed;
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .lora-group button:hover {
            background-color: #6d28d9;
        }

        .selected-loras {
            margin-top: 16px;
            padding: 16px;
            background-color: #333;
            border-radius: 8px;
            border: 1px solid #444;
            color: #e0e0e0;
        }

        .selected-lora-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background-color: #3a3a3a;
            border-radius: 6px;
            border: 1px solid #444;
            color: #e0e0e0;
        }

        .selected-lora-item span {
            color: #e0e0e0;
            font-size: 14px;
        }

        .selected-lora-item button {
            background-color: #7c3aed;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s ease;
        }

        .selected-lora-item button:hover {
            background-color: #6d28d9;
        }

        .lora-item {
            padding: 10px 14px;
            border-radius: 6px;
            background-color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 6px;
            border: 1px solid #444;
        }
        
        .lora-item:hover {
            background-color: #7c3aed;
            color: white;
            border-color: #6d28d9;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            margin-top: 24px;
        }

        .loading-spinner::after {
            content: "";
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 5px solid #333;
            border-top: 5px solid #7c3aed;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Initial Loading Screen */
        #initialLoading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 15, 15, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #initialLoading .spinner {
            width: 50px;
            height: 50px;
            border: 6px solid #333;
            border-top: 6px solid #7c3aed;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 24px;
        }
        
        #initialLoading p {
            font-size: 18px;
            color: #e0e0e0;
        }

        /* Image Grid */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-container {
            border: 1px solid #444;
            border-radius: 12px;
            padding: 16px;
            background-color: #2a2a2a;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .image-container:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        /* Details and summary styling */
        details {
            margin-bottom: 16px;
        }

        details summary {
            cursor: pointer;
            padding: 10px;
            background-color: #333;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        details summary:hover {
            background-color: #3a3a3a;
        }

        details[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: 1px solid #444;
            margin-bottom: 0;
        }

        /* Progress bar styling */
        .progress {
            height: 8px;
            background-color: #333;
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-bar {
            height: 100%;
            background-color: #7c3aed;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Button styling */
        button {
            background-color: #7c3aed;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        button:hover {
            background-color: #6d28d9;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(1px);
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
        }

        /* Toast notifications */
        #toastContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-wrap: wrap;
            }

            .container {
                padding: 16px;
            }

            .card {
                padding: 16px;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <!-- Écran de chargement initial -->
    <div id="initialLoading">
        <div class="spinner"></div>
        <p>Connexion à l'API en cours...</p>
        <div id="serverError" style="display: none; color: #dc3545; background-color: rgba(220, 53, 69, 0.2); padding: 15px; border-radius: 6px; margin-top: 20px; text-align: center;">
            <p style="margin-bottom: 10px;">Erreur de connexion à l'API</p>
            <p style="font-size: 14px; margin-bottom: 15px;">Assurez-vous que le serveur API est en cours d'exécution.</p>
            <button onclick="getServerAddress()" style="padding: 10px 20px; background-color: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer;">Réessayer</button>
        </div>
    </div>
    
    <!-- Écran de connexion -->
    <div id="loginScreen" style="display: none; text-align: center; max-width: 400px; margin: 0 auto; padding: 30px; background-color: #1a1a1a; border-radius: 12px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4);">
        <h1 style="margin-bottom: 30px;">Connexion requise</h1>
        <p style="margin-bottom: 20px; color: #bbb;">Veuillez vous connecter pour accéder à l'application.</p>
        
        <!-- Google Login Button -->
        <button id="googleLoginBtn" style="padding: 12px 24px; background-color: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; display: flex; align-items: center; margin: 0 auto 15px auto;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="margin-right: 10px;">
                <path fill="#ffffff" d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/>
            </svg>
            Se connecter avec Google
        </button>
        
        <!-- Local Login Button -->
        <button id="toggleLocalLoginBtn" style="padding: 12px 24px; background-color: #444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; display: flex; align-items: center; margin: 0 auto;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="margin-right: 10px;">
                <path fill="#ffffff" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
            </svg>
            Se connecter avec identifiants
        </button>
        
        <!-- Local Login Form (hidden by default) -->
        <div id="localLoginForm" style="display: none; margin-top: 20px; text-align: left;">
            <div style="margin-bottom: 15px;">
                <label for="username" style="display: block; margin-bottom: 5px; color: #bbb; font-size: 14px;">Nom d'utilisateur</label>
                <input type="text" id="username" style="width: 100%; padding: 10px; background-color: #333; color: #e0e0e0; border: 1px solid #444; border-radius: 8px;" placeholder="admin">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="password" style="display: block; margin-bottom: 5px; color: #bbb; font-size: 14px;">Mot de passe</label>
                <input type="password" id="password" style="width: 100%; padding: 10px; background-color: #333; color: #e0e0e0; border: 1px solid #444; border-radius: 8px;" placeholder="••••••••">
            </div>
            <button id="localLoginBtn" style="width: 100%; padding: 12px; background-color: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                Se connecter
            </button>
            <p id="localLoginStatus" style="margin-top: 10px; font-size: 14px; color: #bbb;"></p>
        </div>
    </div>

    <div class="container" style="display: none;">
        <h1>Stable Diffusion <span style="color: #7c3aed; font-weight: 800;">WebUI</span></h1>
        
        <!-- Navigation par onglets -->
        <div class="tabs">
            <button class="tab-button active" data-tab="txt2img">Texte vers Image</button>
            <button class="tab-button" data-tab="prompt-gen">Génération de Prompt</button>
            <button class="tab-button" data-tab="img-analysis">Analyse d'Image</button>
            <button class="tab-button" data-tab="settings">Paramètres</button>
        </div>
        
        <!-- Onglet Texte vers Image -->
        <div id="txt2img" class="tab-content active">
        <form id="generateForm">
                <div class="card">
                    <div class="card-header">Prompts</div>
                <div class="form-group">
                        <label for="prompt">Prompt positif :</label>
                        <textarea id="prompt" name="prompt" required placeholder="Décrivez ce que vous souhaitez générer"></textarea>
                </div>
                <div class="form-group">
                    <label for="negative_prompt">Prompt négatif :</label>
                        <textarea id="negative_prompt" name="negative_prompt" placeholder="Éléments à éviter dans l'image"></textarea>
                </div>
                </div>
                
                <div class="card">
                    <div class="card-header">Paramètres de génération</div>
                    <div class="form-grid">
                <div class="form-group">
                    <label for="seed">Seed :</label>
                    <input type="number" id="seed" name="seed" placeholder="Laisser vide pour une seed aléatoire">
                </div>
                <div class="form-group">
                    <label for="sampler">Sampler :</label>
                    <select id="sampler" name="sampler">
                        <option value="dpmpp_2m" selected>dpmpp_2m</option>
                        <option value="euler">euler</option>
                        <option value="ddim">ddim</option>
                        <option value="heun">heun</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="steps">Steps :</label>
                    <input type="number" id="steps" name="steps" value="20" min="1" max="100" required>
                </div>
                <div class="form-group">
                    <label for="num_images">Nombre d'images :</label>
                    <input type="number" id="num_images" name="num_images" value="1" min="1" max="4" required>
                </div>
                <div class="form-group">
                    <label for="user_email">E-mail de notification :</label>
                    <input type="email" id="user_email" name="user_email" placeholder="Entrez votre e-mail">
                        </div>
                </div>
            </div>

                <div class="card">
                    <div class="card-header">LoRAs</div>
                <div class="lora-group">
                        <input type="text" id="loraInput" name="loraInput" placeholder="Nom du LoRA" style="flex-grow: 1; background-color: #333; color: #e0e0e0; border: 1px solid #444; border-radius: 8px; padding: 12px;">
                        <input type="number" id="loraStrength" name="loraStrength" step="0.1" min="0" max="1" placeholder="Puissance" value="1.0" style="background-color: #333; color: #e0e0e0; border: 1px solid #444; border-radius: 8px; padding: 12px;">
                        <button type="button" id="addLoraBtn">Ajouter</button>
                </div>
                    
                    <details style="margin-top: 15px;">
                        <summary style="cursor: pointer; font-weight: 600; color: #bbb; margin-bottom: 10px;">Liste des LoRAs disponibles</summary>
                        <div style="max-height: 200px; overflow-y: auto; background-color: #333; border: 1px solid #444; border-radius: 6px; padding: 10px; font-size: 14px;">
                            <div id="lorasList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 5px;">
                                <!-- Indicateur de chargement -->
                                <div style="grid-column: 1/-1; text-align: center; padding: 20px;">
                                    <div class="loading-spinner" style="display: inline-block;"></div>
                                    <p style="margin-top: 10px; color: #888;">Chargement des LoRAs...</p>
                                </div>
                            </div>
                        </div>
                    </details>
                    
                <div id="selectedLoras" class="selected-loras" style="display: none;">
                        <h3 style="margin-bottom: 10px; font-size: 16px; color: #e0e0e0;">LoRAs sélectionnés:</h3>
                        <div id="lorasSelectedList"></div>
                </div>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <button type="submit" id="generateButton">Générer</button>
            </div>
        </form>

        <!-- Indicateur de chargement -->
        <div id="loadingSpinner" class="loading-spinner"></div>

        <!-- Section pour afficher le statut -->
        <div id="statusBox" class="status-box"></div>

        <!-- Section pour afficher les résultats -->
        <div id="result"></div>
        </div>
        
        <!-- Onglet Génération de Prompt -->
        <div id="prompt-gen" class="tab-content">
            <div class="card">
                <div class="card-header">Générer un prompt avec DeepSeek AI</div>
                <div class="form-group">
                    <label for="promptInstruction">Instructions :</label>
                    <textarea id="promptInstruction" placeholder="Décrivez ce que vous souhaitez générer, par exemple: une forêt enchantée avec des fées"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="promptStyle">Style :</label>
                        <select id="promptStyle">
                            <option value="">Aucun style spécifique</option>
                            <option value="photorealistic">Photoréaliste</option>
                            <option value="cinematic">Cinématique</option>
                            <option value="anime">Anime</option>
                            <option value="digital art">Art numérique</option>
                            <option value="oil painting">Peinture à l'huile</option>
                            <option value="watercolor">Aquarelle</option>
                            <option value="pencil sketch">Croquis au crayon</option>
                            <option value="3D render">Rendu 3D</option>
                            <option value="pixel art">Pixel Art</option>
                            <option value="fantasy">Fantastique</option>
                            <option value="sci-fi">Science-fiction</option>
                            <option value="steampunk">Steampunk</option>
                            <option value="cyberpunk">Cyberpunk</option>
                            <option value="vaporwave">Vaporwave</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="promptTheme">Thème :</label>
                        <select id="promptTheme">
                            <option value="">Aucun thème spécifique</option>
                            <option value="nature">Nature</option>
                            <option value="urban">Urbain</option>
                            <option value="futuristic">Futuriste</option>
                            <option value="medieval">Médiéval</option>
                            <option value="ancient">Ancien</option>
                            <option value="space">Espace</option>
                            <option value="underwater">Sous-marin</option>
                            <option value="desert">Désert</option>
                            <option value="arctic">Arctique</option>
                            <option value="tropical">Tropical</option>
                            <option value="mystical">Mystique</option>
                            <option value="horror">Horreur</option>
                            <option value="romantic">Romantique</option>
                            <option value="abstract">Abstrait</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="promptBackground">Arrière-plan :</label>
                        <select id="promptBackground">
                            <option value="">Arrière-plan par défaut</option>
                            <option value="sunset">Coucher de soleil</option>
                            <option value="sunrise">Lever de soleil</option>
                            <option value="night sky">Ciel nocturne</option>
                            <option value="starry night">Nuit étoilée</option>
                            <option value="cloudy sky">Ciel nuageux</option>
                            <option value="stormy weather">Temps orageux</option>
                            <option value="foggy">Brumeux</option>
                            <option value="snowy">Neigeux</option>
                            <option value="rainy">Pluvieux</option>
                            <option value="forest">Forêt</option>
                            <option value="mountains">Montagnes</option>
                            <option value="beach">Plage</option>
                            <option value="cityscape">Paysage urbain</option>
                            <option value="galaxy">Galaxie</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Aperçu du prompt :</label>
                    <div id="promptPreview" style="width: 100%; min-height: 60px; padding: 10px; border: 1px solid #444; border-radius: 4px; background-color: #333; font-style: italic;">
                        L'aperçu du prompt apparaîtra ici...
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="maxTokens">Nombre maximum de tokens :</label>
                    <input type="number" id="maxTokens" value="500" min="100" max="1000">
                    <small style="display: block; margin-top: 5px; color: #888;">Plus la valeur est élevée, plus le prompt généré sera détaillé.</small>
                </div>
                
                <div class="form-group" style="text-align: center; margin-top: 15px;">
                    <button type="button" id="generatePromptBtn">Générer un prompt</button>
                </div>
                
                <!-- Résultats de la génération de prompt -->
                <div id="promptGenerationResult" style="display: none; margin-top: 15px; padding: 15px; background-color: #333; border-radius: 6px; border: 1px solid #444;">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="generatedPositivePrompt">Prompt positif :</label>
                        <textarea id="generatedPositivePrompt" style="min-height: 120px;" readonly></textarea>
                        <button type="button" id="usePositivePromptBtn" style="margin-top: 10px;">Utiliser comme prompt positif</button>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="generatedNegativePrompt">Prompt négatif :</label>
                        <textarea id="generatedNegativePrompt" style="min-height: 80px;" readonly></textarea>
                        <button type="button" id="useNegativePromptBtn" style="margin-top: 10px;">Utiliser comme prompt négatif</button>
                    </div>
                </div>
                
                <div id="promptGenerationLoading" class="loading-spinner"></div>
                <div id="promptGenerationError" style="display: none; margin-top: 15px; padding: 10px; background-color: rgba(220, 53, 69, 0.2); color: #dc3545; border-radius: 4px; border: 1px solid rgba(220, 53, 69, 0.3);"></div>
            </div>
            
            <!-- Configuration de la clé API DeepSeek -->
            <div class="card">
                <div class="card-header">Configuration DeepSeek API</div>
                <p style="margin-bottom: 15px; font-size: 14px; color: #bbb;">Pour utiliser la génération de prompt avec DeepSeek, vous devez configurer votre clé API :</p>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="password" id="deepSeekApiKey" placeholder="Entrez votre clé API DeepSeek" style="flex-grow: 1;">
                    <button type="button" id="saveApiKeyBtn" style="white-space: nowrap;">Enregistrer</button>
                </div>
                <div id="apiKeyStatus" style="font-size: 14px; margin-top: 5px;"></div>
            </div>
        </div>
        
        <!-- Onglet Analyse d'Image -->
        <div id="img-analysis" class="tab-content">
            <div class="card">
                <div class="card-header">Analyser une image avec Google Vision</div>
                
                <!-- Zone de téléchargement d'image -->
                <div style="margin-bottom: 15px; border: 1px dashed #444; border-radius: 6px; padding: 20px; text-align: center;">
                    <div id="dropZone" style="cursor: pointer; padding: 20px;">
                        <p style="margin-bottom: 10px; font-size: 16px;">Glissez une image ici ou cliquez pour sélectionner</p>
                        <p style="font-size: 14px; color: #888;">Formats acceptés: JPG, PNG, JPEG, WEBP</p>
                        <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                        <button type="button" id="uploadButton" style="margin-top: 10px; padding: 8px 15px;">Sélectionner une image</button>
                    </div>
                    <div id="imagePreview" style="display: none; margin-top: 15px;">
                        <img id="previewImg" style="max-width: 100%; max-height: 300px; border-radius: 4px;">
                        <p id="imageInfo" style="margin-top: 5px; font-size: 14px; color: #888;"></p>
                        <button type="button" id="removeImageBtn" style="margin-top: 10px; padding: 5px 10px; background-color: #dc3545;">Supprimer l'image</button>
                    </div>
                </div>
                
                <!-- Bouton de description -->
                <div style="text-align: center; margin-bottom: 15px;">
                    <button type="button" id="describeImageBtn" style="padding: 10px 20px;" disabled>Analyser l'image avec Google Vision</button>
                </div>
                
                <!-- Résultats de la description -->
                <div id="imageDescriptionResult" style="display: none; margin-top: 15px; padding: 15px; background-color: #333; border-radius: 6px; border: 1px solid #444;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px;">Description positive :</label>
                        <textarea id="positiveDescription" style="width: 100%; min-height: 80px;" readonly></textarea>
                        <button type="button" id="usePositiveBtn" style="margin-top: 5px; padding: 5px 10px; background-color: #28a745;">Utiliser comme prompt positif</button>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px;">Description négative :</label>
                        <textarea id="negativeDescription" style="width: 100%; min-height: 80px;" readonly></textarea>
                        <button type="button" id="useNegativeBtn" style="margin-top: 5px; padding: 5px 10px; background-color: #28a745;">Utiliser comme prompt négatif</button>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 5px;">Détails de l'analyse :</label>
                        <div id="analysisDetails" style="margin-top: 10px; padding: 10px; background-color: #2a2a2a; border-radius: 4px; font-size: 14px; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
                
                <div id="imageDescriptionLoading" class="loading-spinner"></div>
                <div id="imageDescriptionError" style="display: none; margin-top: 15px; padding: 10px; background-color: rgba(220, 53, 69, 0.2); color: #dc3545; border-radius: 4px; border: 1px solid rgba(220, 53, 69, 0.3);"></div>
            </div>
            
            <!-- Configuration de la clé API Google Vision -->
            <div class="card">
                <div class="card-header">Configuration Google Vision API</div>
                <p style="margin-bottom: 15px; font-size: 14px; color: #bbb;">Pour utiliser l'analyse d'images avec Google Vision, vous devez configurer votre clé API :</p>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="password" id="googleVisionApiKey" placeholder="Entrez votre clé API Google Vision" style="flex-grow: 1;">
                    <button type="button" id="saveGoogleVisionKeyBtn" style="white-space: nowrap;">Enregistrer</button>
                </div>
                <div id="googleVisionKeyStatus" style="font-size: 14px; margin-top: 5px;"></div>
            </div>
        </div>
        
        <!-- Onglet Paramètres -->
        <div id="settings" class="tab-content">
            <div class="card">
                <div class="card-header">Paramètres du serveur</div>
                <p style="margin-bottom: 15px; font-size: 14px; color: #bbb;">Adresse du serveur actuelle: <span id="currentServerAddress"></span></p>
                <button type="button" onclick="getServerAddress()" style="padding: 8px 15px;">Reconnecter au serveur</button>
            </div>
            
            <div class="card">
                <div class="card-header">Maintenance ComfyUI</div>
                <p style="margin-bottom: 15px; font-size: 14px; color: #bbb;">Si vous rencontrez des problèmes de mémoire ou de performance avec ComfyUI, vous pouvez le redémarrer ici.</p>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button type="button" id="restartComfyUIBtn" class="restart-btn" style="background-color: #7c3aed; color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-weight: 500;">Redémarrer ComfyUI</button>
                    <span id="restartStatus" style="font-size: 14px; color: #bbb;"></span>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">Informations du compte</div>
                <div id="accountInfo" style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <img id="userPicture" src="" alt="Photo de profil" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; background-color: #333;">
                        <div>
                            <p id="userName" style="font-weight: 600; margin-bottom: 5px;"></p>
                            <p id="userEmail" style="font-size: 14px; color: #bbb;"></p>
                        </div>
                    </div>
                    <button id="logoutBtn" style="background-color: #dc3545; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 500;">Se déconnecter</button>
                </div>
            </div>
            
            <div id="adminPanel" class="card" style="display: none;">
                <div class="card-header">Administration des utilisateurs</div>
                <p style="margin-bottom: 15px; font-size: 14px; color: #bbb;">Gérez les utilisateurs autorisés à accéder à l'application.</p>
                
                <div style="margin-bottom: 15px;">
                    <label for="authorizedUsers" style="display: block; margin-bottom: 8px; font-weight: 500;">Utilisateurs autorisés (adresses e-mail, une par ligne) :</label>
                    <textarea id="authorizedUsers" style="width: 100%; min-height: 100px; padding: 10px; background-color: #333; color: #e0e0e0; border: 1px solid #444; border-radius: 8px;"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button id="saveAuthorizedUsersBtn" style="background-color: #7c3aed; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 500;">Enregistrer</button>
                    <span id="authorizedUsersStatus" style="font-size: 14px; color: #bbb;"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let ngrokAddress = "";  // Sera défini après la récupération depuis le serveur
        let serverAddress = ""; // Alias pour ngrokAddress, pour plus de clarté
        let selectedImage = null; // Pour stocker l'image sélectionnée
        const selectedLoras = []; // Pour stocker les LoRAs sélectionnés
        let currentUser = null; // Pour stocker les informations de l'utilisateur connecté
        let isAdmin = false; // Pour indiquer si l'utilisateur est administrateur
        
        // Fonction pour récupérer l'adresse du serveur
        async function getServerAddress() {
            try {
                // Essayer d'abord l'adresse locale
                try {
                    // Créer une promesse qui se résout après un délai (timeout)
                    const timeout = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout')), 2000)
                    );
                    
                    // Utiliser Promise.race pour implémenter un timeout sur fetch
                    const localResponse = await Promise.race([
                        fetch('http://localhost:5000/check_config'),
                        timeout
                    ]);
                    
                    if (localResponse.ok) {
                        ngrokAddress = 'http://localhost:5000';
                        serverAddress = ngrokAddress;
                        console.log('Connexion établie avec le serveur local');
                        
                        // Masquer l'écran de chargement
                        document.getElementById('initialLoading').style.display = 'none';
                        
                        // Vérifier l'état de l'authentification
                        checkAuthStatus();
                        
                        // Mettre à jour l'adresse du serveur dans l'onglet Paramètres
                        const serverAddressElement = document.getElementById('currentServerAddress');
                        if (serverAddressElement) {
                            serverAddressElement.textContent = serverAddress;
                        }
                        
                        return true;
                    }
                } catch (localError) {
                    console.log('Serveur local non disponible, tentative avec ngrok...');
                }
                
                // Si le serveur local n'est pas disponible, utiliser l'adresse ngrok
                ngrokAddress = "https://46be-86-71-29-249.ngrok-free.app";
                serverAddress = ngrokAddress; // Définir les deux variables
                console.log(`Using hardcoded ngrok address: ${ngrokAddress}`);
                
                // Vérifier si le serveur est accessible
                const response = await fetch(`${ngrokAddress}/check_config`);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                // Masquer l'écran de chargement
                document.getElementById('initialLoading').style.display = 'none';
                
                // Vérifier l'état de l'authentification
                checkAuthStatus();
                
                // Mettre à jour l'adresse du serveur dans l'onglet Paramètres
                const serverAddressElement = document.getElementById('currentServerAddress');
                if (serverAddressElement) {
                    serverAddressElement.textContent = serverAddress;
                }
                
                return true;
            } catch (error) {
                console.error("Erreur lors de la récupération de l'adresse du serveur:", error);
                document.getElementById('serverError').style.display = 'block';
                return false;
            }
        }
        
        // Fonction pour remplir le champ de saisie avec le nom du LoRA sélectionné
        function fillLoraInput(loraName) {
            document.getElementById('loraInput').value = loraName;
        }
        
        // Fonction pour ajouter un LoRA à partir du champ de saisie
        function addLoraFromInput() {
            const loraName = document.getElementById('loraInput').value.trim();
            const loraStrength = parseFloat(document.getElementById('loraStrength').value);

            if (!loraName) {
                alert("Veuillez entrer un nom de LoRA");
                return;
            }

            if (isNaN(loraStrength) || loraStrength < 0 || loraStrength > 1) {
                alert("La puissance du LoRA doit être un nombre entre 0 et 1");
                return;
            }

            // Vérifier si ce LoRA est déjà sélectionné
            const existingIndex = selectedLoras.findIndex(lora => lora.name === loraName);
            if (existingIndex !== -1) {
                // Mettre à jour la puissance si le LoRA existe déjà
                selectedLoras[existingIndex].strength = loraStrength;
            } else {
                // Ajouter un nouveau LoRA
                selectedLoras.push({
                    name: loraName,
                    strength: loraStrength
                });
            }

            // Mettre à jour l'affichage
            updateLorasList();
            
            // Effacer le champ de saisie
            document.getElementById('loraInput').value = '';
        }

        // Fonction pour afficher un message d'erreur
        function showError(message) {
            const statusBox = document.getElementById('statusBox');
            statusBox.textContent = `Erreur : ${message}`;
            statusBox.className = "status-box error";
            statusBox.style.display = 'block';
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('generateButton').disabled = false;
        }

        // Fonction pour afficher un message de succès
        function showSuccess(message) {
            const statusBox = document.getElementById('statusBox');
            statusBox.textContent = message;
            statusBox.className = "status-box success";
            statusBox.style.display = 'block';
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('generateButton').disabled = false;
        }

        // Fonction pour supprimer un LoRa de la liste des sélectionnés
        function removeLora(index) {
            selectedLoras.splice(index, 1);
            updateLorasList();
        }

        // Fonction pour mettre à jour l'affichage des LoRAs sélectionnés
        function updateLorasList() {
            const lorasList = document.getElementById('lorasSelectedList');
            const selectedLorasContainer = document.getElementById('selectedLoras');
            
            // Vider la liste actuelle
            lorasList.innerHTML = '';
            
            // Afficher ou masquer le conteneur selon qu'il y a des LoRAs sélectionnés
            if (selectedLoras.length > 0) {
                selectedLorasContainer.style.display = 'block';
                
                // Ajouter chaque LoRA à la liste
                selectedLoras.forEach((lora, index) => {
                    const loraItem = document.createElement('div');
                    loraItem.className = 'selected-lora-item';
                    loraItem.innerHTML = `
                        <span>${lora.name} (Force: ${lora.strength})</span>
                        <button type="button" onclick="removeLora(${index})">Supprimer</button>
                    `;
                    lorasList.appendChild(loraItem);
                });
            } else {
                selectedLorasContainer.style.display = 'none';
            }
        }

        // Gestion de la soumission du formulaire
        document.getElementById('generateForm').addEventListener('submit', function (e) {
            e.preventDefault();

            // Désactiver le bouton et afficher l'indicateur de chargement
            document.getElementById('generateButton').disabled = true;
            document.getElementById('loadingSpinner').style.display = 'block';
            
            const statusBox = document.getElementById('statusBox');
            statusBox.style.display = 'none'; // Cache le statut avant la requête

            // Récupérer les données du formulaire
            const formData = {
                prompt: document.getElementById('prompt').value,
                negative_prompt: document.getElementById('negative_prompt').value,
                seed: parseInt(document.getElementById('seed').value) || 0, // 0 indique une seed aléatoire
                sampler: document.getElementById('sampler').value,
                steps: parseInt(document.getElementById('steps').value),
                num_images: parseInt(document.getElementById('num_images').value),
                loras: selectedLoras,
                user_email: document.getElementById('user_email').value || null
            };

            // Afficher les LoRAs sélectionnés dans la console pour débogage
            if (selectedLoras.length > 0) {
                console.log(`Envoi de ${selectedLoras.length} LoRAs:`);
                selectedLoras.forEach((lora, index) => {
                    console.log(`  - LoRA ${index+1}: ${lora.name} (Force: ${lora.strength})`);
                });
            } else {
                console.log("Aucun LoRA sélectionné");
            }

            console.log(`Envoi de la requête à ${ngrokAddress}/generate`);
            console.log("Données envoyées:", JSON.stringify(formData));

            // Afficher un message temporaire
            showSuccess(`Envoi de la requête à l'API (${ngrokAddress})...`);

            // Envoyer la requête au serveur
            fetch(`${ngrokAddress}/generate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Affiche un message de succès
                const numImages = parseInt(document.getElementById('num_images').value);
                showSuccess(`Tout va bien ! La génération de ${numImages} image(s) a été ajoutée à la file d'attente et sera traitée bientôt.`);

                // Calculer un temps d'attente approprié basé sur le nombre d'images
                // Temps fixe de 6 minutes (360 secondes) pour la barre de progression
                const fixedWaitTime = 360000; // 6 minutes en millisecondes
                
                // Temps réel estimé pour la génération (pour le timeout de vérification)
                const steps = parseInt(document.getElementById('steps').value);
                const estimatedTimePerImage = steps * 1000 + 5000; 
                const actualWaitTime = Math.max(5000, numImages * estimatedTimePerImage);
                
                // Afficher un compte à rebours basé sur le temps fixe
                let remainingTime = Math.floor(fixedWaitTime / 1000);
                const countdownInterval = setInterval(() => {
                    remainingTime--;
                    if (remainingTime <= 0) {
                        clearInterval(countdownInterval);
                        showSuccess(`Vérification des images générées...`);
                        refreshImages();
                    } else {
                        showSuccess(`Génération en cours... Vérification automatique dans ${remainingTime} secondes. Vous pouvez aussi vérifier manuellement en cliquant ci-dessous.`);
                        
                        // Ajouter un bouton pour vérifier manuellement
                        if (!document.getElementById('manualCheckBtn')) {
                            const resultDiv = document.getElementById('result');
                            resultDiv.innerHTML = `
                                <p>Génération en cours. Veuillez patienter...</p>
                                <div class="progress" style="height: 20px; margin-top: 10px; background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                                    <div class="progress-bar" style="height: 100%; background-color: #7c3aed; width: 0%;"></div>
                                </div>
                                <button id="manualCheckBtn" style="margin-top: 15px; padding: 8px 15px; background-color: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer;">Vérifier maintenant</button>
                            `;
                            
                            // Mettre à jour la barre de progression
                            const progressBar = document.querySelector('.progress-bar');
                            const totalTime = Math.floor(fixedWaitTime / 1000);
                            const progress = ((totalTime - remainingTime) / totalTime) * 100;
                            progressBar.style.width = `${progress}%`;
                            
                            document.getElementById('manualCheckBtn').addEventListener('click', refreshImages);
                        } else {
                            // Mettre à jour la barre de progression
                            const progressBar = document.querySelector('.progress-bar');
                            const totalTime = Math.floor(fixedWaitTime / 1000);
                            const progress = ((totalTime - remainingTime) / totalTime) * 100;
                            progressBar.style.width = `${progress}%`;
                        }
                    }
                }, 1000);
                
                // Configurer le timeout pour vérifier automatiquement
                // Utiliser le temps réel estimé pour le timeout, pas le temps fixe de la barre
                setTimeout(() => {
                    clearInterval(countdownInterval);
                    showSuccess(`Vérification des images générées...`);
                    refreshImages();
                }, actualWaitTime);
            })
            .catch(error => {
                showError(`Erreur lors de la communication avec l'API: ${error.message}`);
                console.error('Erreur :', error);
            });
        });

        // Fonction pour rafraîchir les images
        function refreshImages() {
            // Récupérer le nombre d'images demandé
            const numImages = parseInt(document.getElementById('num_images').value) || 1;
            
            console.log(`Récupération des ${numImages} dernières images depuis ${ngrokAddress}/list_images`);
            
            // Afficher un message de chargement
            showSuccess(`Récupération des ${numImages} dernières images...`);
            
            // Préparer le div de résultat pour afficher un indicateur de chargement
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <p style="margin-bottom: 15px;">Chargement des images en cours...</p>
                    <div class="loading-spinner" style="display: block; margin: 20px auto;"></div>
                </div>
            `;
            
            // Ajouter un timestamp pour éviter le cache du navigateur
            const url = `${ngrokAddress}/list_images?num_images=${numImages}&_nocache=${Date.now()}`;
            console.log("Requesting URL:", url);
            
            // Récupérer la liste des images
            fetch(url)
                .then(response => {
                    console.log("Response status:", response.status);
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Images data received:", data);
                    
                    if (data.image_urls && data.image_urls.length > 0) {
                        // Afficher le nombre d'images trouvées
                        showSuccess(`${data.image_urls.length} image(s) trouvée(s) sur ${numImages} demandée(s) !`);
                        
                        // Préparer le conteneur pour les images
                        resultDiv.innerHTML = `
                            <div style="margin-bottom: 15px;">
                                <h3 style="font-size: 18px; margin-bottom: 10px;">Dernières images générées</h3>
                                <p style="font-size: 14px; color: #666;">Images stockées dans: ${data.output_dir}</p>
                            </div>
                        `;
                        
                        // Créer une grille pour afficher les images
                        const imageGrid = document.createElement('div');
                        imageGrid.style.display = 'grid';
                        imageGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(300px, 1fr))';
                        imageGrid.style.gap = '15px';
                        imageGrid.style.marginTop = '15px';
                        
                        // Utiliser les URLs statiques si disponibles, sinon utiliser les URLs complètes
                        const imageUrls = data.static_urls && data.static_urls.length > 0 
                            ? data.static_urls.map(url => `${ngrokAddress}${url}`) 
                            : data.image_urls;
                        
                        // Ajouter chaque image à la grille
                        imageUrls.forEach((url, index) => {
                            // Créer un conteneur pour l'image
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'image-container';
                            imgContainer.style.border = '1px solid #ddd';
                            imgContainer.style.borderRadius = '8px';
                            imgContainer.style.padding = '15px';
                            imgContainer.style.backgroundColor = '#f9f9f9';
                            imgContainer.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                            imgContainer.style.transition = 'transform 0.2s';
                            imgContainer.style.cursor = 'pointer';
                            
                            // Ajouter un effet hover
                            imgContainer.onmouseover = function() {
                                this.style.transform = 'scale(1.02)';
                            };
                            imgContainer.onmouseout = function() {
                                this.style.transform = 'scale(1)';
                            };
                            
                            // Extraire le nom du fichier de l'URL
                            const filename = url.split('/').pop();
                            
                            // Ajouter un titre pour l'image
                            const imgTitle = document.createElement('div');
                            imgTitle.innerHTML = `
                                <h4 style="font-size: 16px; margin-bottom: 5px;">Image ${index + 1}</h4>
                                <p style="font-size: 12px; color: #666; margin-bottom: 10px; word-break: break-all;">${filename}</p>
                            `;
                            imgContainer.appendChild(imgTitle);
                            
                            // Ajouter un conteneur pour l'image avec un ratio d'aspect fixe
                            const imgWrapper = document.createElement('div');
                            imgWrapper.style.position = 'relative';
                            imgWrapper.style.width = '100%';
                            imgWrapper.style.paddingBottom = '100%'; // Ratio carré
                            imgWrapper.style.overflow = 'hidden';
                            imgWrapper.style.borderRadius = '4px';
                            imgWrapper.style.backgroundColor = '#eee';
                            imgContainer.appendChild(imgWrapper);
                            
                            // Ajouter un indicateur de chargement
                            const loadingIndicator = document.createElement('div');
                            loadingIndicator.className = 'loading-spinner';
                            loadingIndicator.style.display = 'block';
                            loadingIndicator.style.position = 'absolute';
                            loadingIndicator.style.top = '50%';
                            loadingIndicator.style.left = '50%';
                            loadingIndicator.style.transform = 'translate(-50%, -50%)';
                            imgWrapper.appendChild(loadingIndicator);
                            
                            // Créer l'élément image avec un timestamp pour éviter le cache
                            const img = document.createElement('img');
                            img.src = `${url}?_nocache=${Date.now()}`;
                            img.style.position = 'absolute';
                            img.style.top = '0';
                            img.style.left = '0';
                            img.style.width = '100%';
                            img.style.height = '100%';
                            img.style.objectFit = 'cover';
                            img.style.display = 'none'; // Cacher jusqu'au chargement complet
                            
                            // Gérer le chargement réussi
                            img.onload = function() {
                                loadingIndicator.style.display = 'none';
                                img.style.display = 'block';
                                console.log(`Image ${index + 1} chargée avec succès: ${url}`);
                            };
                            
                            // Gérer l'erreur de chargement
                            img.onerror = function() {
                                console.error(`Erreur de chargement de l'image ${index + 1}: ${url}`);
                                loadingIndicator.style.display = 'none';
                                const errorMsg = document.createElement('div');
                                errorMsg.style.position = 'absolute';
                                errorMsg.style.top = '50%';
                                errorMsg.style.left = '50%';
                                errorMsg.style.transform = 'translate(-50%, -50%)';
                                errorMsg.style.textAlign = 'center';
                                errorMsg.style.width = '80%';
                                errorMsg.innerHTML = `
                                    <p style="color: #721c24; margin-bottom: 10px;">Image non disponible</p>
                                    <button class="retry-btn" style="padding: 5px 10px; background-color: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer;">Réessayer</button>
                                `;
                                imgWrapper.appendChild(errorMsg);
                                
                                // Ajouter un gestionnaire pour réessayer
                                errorMsg.querySelector('.retry-btn').addEventListener('click', function(e) {
                                    e.stopPropagation(); // Empêcher la propagation au conteneur parent
                                    errorMsg.remove();
                                    loadingIndicator.style.display = 'block';
                                    img.src = `${url}?_nocache=${Date.now()}`;
                                });
                            };
                            
                            imgWrapper.appendChild(img);
                            
                            // Ajouter un gestionnaire de clic pour ouvrir l'image en plein écran
                            imgContainer.addEventListener('click', function() {
                                window.open(img.src, '_blank');
                            });
                            
                            // Ajouter le conteneur à la grille
                            imageGrid.appendChild(imgContainer);
                        });
                        
                        resultDiv.appendChild(imageGrid);
                        
                        // Ajouter un bouton pour rafraîchir les images
                        const refreshButton = document.createElement('button');
                        refreshButton.textContent = 'Rafraîchir les images';
                        refreshButton.style.display = 'block';
                        refreshButton.style.margin = '20px auto';
                        refreshButton.style.padding = '10px 20px';
                        refreshButton.style.backgroundColor = '#28a745';
                        refreshButton.style.color = 'white';
                        refreshButton.style.border = 'none';
                        refreshButton.style.borderRadius = '4px';
                        refreshButton.style.cursor = 'pointer';
                        refreshButton.style.fontSize = '16px';
                        refreshButton.onclick = refreshImages;
                        resultDiv.appendChild(refreshButton);
                    } else {
                        // Aucune image trouvée
                        resultDiv.innerHTML = `
                            <div style="text-align: center; padding: 30px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                                <h3 style="font-size: 18px; color: #495057; margin-bottom: 15px;">Aucune image disponible</h3>
                                <p style="color: #6c757d; margin-bottom: 15px;">La génération est peut-être encore en cours. Veuillez patienter...</p>
                                <p style="font-style: italic; font-size: 14px; color: #6c757d; margin-bottom: 20px;">Note: La génération d'images peut prendre jusqu'à une minute par image.</p>
                                <button id="checkAgainBtn" style="padding: 10px 20px; background-color: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">Vérifier à nouveau</button>
                            </div>
                        `;
                        
                        document.getElementById('checkAgainBtn').addEventListener('click', refreshImages);
                        
                        // Programmer une nouvelle tentative automatique après 5 secondes
                        showSuccess(`Aucune image trouvée. Nouvelle vérification automatique dans 5 secondes...`);
                        setTimeout(refreshImages, 5000);
                    }
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des images:', error);
                    
                    // Afficher un message d'erreur plus convivial
                    resultDiv.innerHTML = `
                        <div style="text-align: center; padding: 30px; background-color: #f8d7da; border-radius: 8px; border: 1px solid #f5c6cb;">
                            <h3 style="font-size: 18px; color: #721c24; margin-bottom: 15px;">La vérification des images a échoué</h3>
                            <p style="color: #721c24; margin-bottom: 15px;">Les images sont probablement encore en cours de génération.</p>
                            <p style="font-style: italic; font-size: 14px; color: #721c24; margin-bottom: 20px;">Erreur: ${error.message}</p>
                            <button id="retryBtn" style="padding: 10px 20px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">Vérifier à nouveau</button>
                        </div>
                    `;
                    
                    document.getElementById('retryBtn').addEventListener('click', refreshImages);
                    
                    // Programmer une nouvelle tentative automatique après 5 secondes
                    showSuccess(`Erreur lors de la vérification. Nouvelle tentative dans 5 secondes...`);
                    setTimeout(refreshImages, 5000);
                });
        }
        
        // Fonction pour vérifier la configuration Google Vision
        function checkGoogleVisionConfig() {
            fetch(`${ngrokAddress}/check_config`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        const apiKeyStatus = document.getElementById('googleVisionKeyStatus');
                        if (data.config.google_vision_api_key_configured) {
                            apiKeyStatus.textContent = "✅ Clé API Google Vision configurée";
                            apiKeyStatus.style.color = "#28a745";
                            
                            // Activer le bouton de description d'image si une image est sélectionnée
                            updateDescribeImageButton();
                        } else {
                            apiKeyStatus.textContent = "❌ Clé API Google Vision non configurée";
                            apiKeyStatus.style.color = "#dc3545";
                            
                            // Désactiver le bouton de description d'image
                            document.getElementById('describeImageBtn').disabled = true;
                        }
                    }
                })
                .catch(error => {
                    console.error("Erreur lors de la vérification de la configuration Google Vision:", error);
                });
        }
        
        // Fonction pour sauvegarder la clé API Google Vision
        function saveGoogleVisionApiKey() {
            const apiKey = document.getElementById('googleVisionApiKey').value.trim();
            
            if (!apiKey) {
                alert("Veuillez entrer une clé API Google Vision valide.");
                return;
            }
            
            // Désactiver le bouton pendant la sauvegarde
            const saveBtn = document.getElementById('saveGoogleVisionKeyBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = "Sauvegarde...";
            
            // Mettre à jour le statut
            const apiKeyStatus = document.getElementById('googleVisionKeyStatus');
            apiKeyStatus.textContent = "Sauvegarde en cours...";
            apiKeyStatus.style.color = "#7c3aed";
            
            // Envoyer la requête pour mettre à jour la clé API
            fetch(`${ngrokAddress}/update_google_vision_key`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    api_key: apiKey
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Réactiver le bouton
                saveBtn.disabled = false;
                saveBtn.textContent = "Enregistrer";
                
                if (data.status === 'success') {
                    // Mettre à jour le statut
                    apiKeyStatus.textContent = "✅ Clé API Google Vision sauvegardée avec succès";
                    apiKeyStatus.style.color = "#28a745";
                    
                    // Effacer le champ de saisie
                    document.getElementById('googleVisionApiKey').value = "";
                    
                    // Vérifier la configuration pour mettre à jour l'interface
                    setTimeout(checkGoogleVisionConfig, 1000);
                } else {
                    // Afficher l'erreur
                    apiKeyStatus.textContent = `❌ Erreur: ${data.message}`;
                    apiKeyStatus.style.color = "#dc3545";
                }
            })
            .catch(error => {
                // Réactiver le bouton
                saveBtn.disabled = false;
                saveBtn.textContent = "Enregistrer";
                
                // Afficher l'erreur
                apiKeyStatus.textContent = `❌ Erreur: ${error.message}`;
                apiKeyStatus.style.color = "#dc3545";
                
                console.error("Erreur lors de la sauvegarde de la clé API Google Vision:", error);
            });
        }
        
        // Variables pour stocker l'image sélectionnée
        // La variable selectedImage est déjà déclarée globalement
        
        // Fonction pour mettre à jour le bouton de description d'image
        function updateDescribeImageButton() {
            const describeBtn = document.getElementById('describeImageBtn');
            if (!describeBtn) return;
            
            const hasImage = selectedImage !== null;
            const hasApiKey = document.getElementById('googleVisionKeyStatus') && 
                              document.getElementById('googleVisionKeyStatus').textContent === 'Configuré';
            
            describeBtn.disabled = !hasImage || !hasApiKey;
            
            if (!hasImage) {
                describeBtn.title = 'Veuillez d\'abord sélectionner une image';
            } else if (!hasApiKey) {
                describeBtn.title = 'Veuillez configurer la clé API Google Vision';
            } else {
                describeBtn.title = 'Analyser l\'image avec Google Vision';
            }
        }
        
        // Fonction pour gérer le téléchargement d'image
        function handleImageUpload(file) {
            if (!file) return;
            
            // Vérifier si le fichier est une image
            if (!file.type.match('image.*')) {
                showToast('Veuillez sélectionner une image valide (JPG, PNG, JPEG, WEBP)', 'error');
                return;
            }
            
            // Vérifier la taille du fichier (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast('L\'image est trop volumineuse (max 5MB)', 'error');
                return;
            }
            
            // Stocker l'image sélectionnée
            selectedImage = file;
            
            // Afficher l'aperçu de l'image
            const reader = new FileReader();
            reader.onload = function(e) {
                const imagePreview = document.getElementById('imagePreview');
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                
                // Afficher le nom du fichier
                const fileNameElement = document.getElementById('selectedFileName');
                if (fileNameElement) {
                    fileNameElement.textContent = file.name;
                    fileNameElement.style.display = 'block';
                }
                
                // Afficher le bouton de suppression
                const removeBtn = document.getElementById('removeImageBtn');
                if (removeBtn) {
                    removeBtn.style.display = 'inline-block';
                }
                
                // Mettre à jour l'état du bouton de description
                updateDescribeImageButton();
                
                // Masquer la zone de glisser-déposer
                const dropZone = document.getElementById('dropZone');
                if (dropZone) {
                    dropZone.style.display = 'none';
                }
                
                // Afficher un message de succès
                showToast('Image téléchargée avec succès', 'success');
            };
            reader.readAsDataURL(file);
        }
        
        // Fonction pour supprimer l'image sélectionnée
        function removeSelectedImage() {
            // Réinitialiser la variable d'image
            selectedImage = null;
            
            // Réinitialiser l'aperçu
            const imagePreview = document.getElementById('imagePreview');
            if (imagePreview) {
                imagePreview.src = '';
                imagePreview.style.display = 'none';
            }
            
            // Masquer le nom du fichier
            const fileNameElement = document.getElementById('selectedFileName');
            if (fileNameElement) {
                fileNameElement.textContent = '';
                fileNameElement.style.display = 'none';
            }
            
            // Masquer le bouton de suppression
            const removeBtn = document.getElementById('removeImageBtn');
            if (removeBtn) {
                removeBtn.style.display = 'none';
            }
            
            // Afficher la zone de glisser-déposer
            const dropZone = document.getElementById('dropZone');
            if (dropZone) {
                dropZone.style.display = 'block';
            }
            
            // Réinitialiser les résultats de description
            const resultContainer = document.getElementById('imageDescriptionResults');
            if (resultContainer) {
                resultContainer.innerHTML = '';
            }
            
            // Réinitialiser les descriptions
            const positiveDesc = document.getElementById('positiveDescription');
            const negativeDesc = document.getElementById('negativeDescription');
            if (positiveDesc) positiveDesc.value = '';
            if (negativeDesc) negativeDesc.value = '';
            
            // Réinitialiser les détails d'analyse
            const analysisDetails = document.getElementById('analysisDetails');
            if (analysisDetails) {
                analysisDetails.innerHTML = '';
            }
            
            // Désactiver les boutons d'utilisation des descriptions
            const usePositiveBtn = document.getElementById('usePositiveBtn');
            const useNegativeBtn = document.getElementById('useNegativeBtn');
            if (usePositiveBtn) usePositiveBtn.disabled = true;
            if (useNegativeBtn) useNegativeBtn.disabled = true;
            
            // Mettre à jour l'état du bouton de description
            updateDescribeImageButton();
            
            // Afficher un message
            showToast('Image supprimée', 'info');
        }
        
        // Fonction pour décrire l'image avec Google Vision API
        function describeImageWithGoogleVision() {
            if (!selectedImage) {
                showToast('Veuillez d\'abord sélectionner une image', 'warning');
                return;
            }
            
            // Vérifier si la clé API est configurée
            if (!checkGoogleVisionConfig()) {
                return;
            }
            
            // Afficher un indicateur de chargement
            const resultContainer = document.getElementById('imageDescriptionResults');
            resultContainer.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner-border" role="status"></div><p>Analyse de l\'image en cours...</p></div>';
            
            // Préparer les données pour l'envoi
            const formData = new FormData();
            formData.append('image', selectedImage);
            
            // Envoyer la requête au serveur
            fetch(`${ngrokAddress}/describe_image_google_vision`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Afficher les descriptions générées
                    document.getElementById('positiveDescription').value = data.positive_description;
                    document.getElementById('negativeDescription').value = data.negative_description;
                    
                    // Afficher les détails de l'analyse
                    let detailsHtml = '<div style="margin-top: 20px;">';
                    
                    // Afficher les étiquettes
                    if (data.labels && data.labels.length > 0) {
                        detailsHtml += '<div style="margin-bottom: 15px;"><h5>Étiquettes détectées:</h5><ul style="list-style-type: disc; padding-left: 20px;">';
                        data.labels.forEach(label => {
                            detailsHtml += `<li>${label.description} (${Math.round(label.score * 100)}%)</li>`;
                        });
                        detailsHtml += '</ul></div>';
                    }
                    
                    // Afficher les objets
                    if (data.objects && data.objects.length > 0) {
                        detailsHtml += '<div style="margin-bottom: 15px;"><h5>Objets détectés:</h5><ul style="list-style-type: disc; padding-left: 20px;">';
                        data.objects.forEach(obj => {
                            detailsHtml += `<li>${obj.name} (${Math.round(obj.score * 100)}%)</li>`;
                        });
                        detailsHtml += '</ul></div>';
                    }
                    
                    // Afficher les couleurs dominantes
                    if (data.colors && data.colors.length > 0) {
                        detailsHtml += '<div style="margin-bottom: 15px;"><h5>Couleurs dominantes:</h5><div style="display: flex; flex-wrap: wrap;">';
                        data.colors.forEach(color => {
                            const rgbColor = `rgb(${color.color.red}, ${color.color.green}, ${color.color.blue})`;
                            detailsHtml += `
                                <div style="margin-right: 10px; margin-bottom: 10px; text-align: center;">
                                    <div style="width: 30px; height: 30px; background-color: ${rgbColor}; border: 1px solid #ddd; border-radius: 4px;"></div>
                                    <small>${Math.round(color.score * 100)}%</small>
                                </div>
                            `;
                        });
                        detailsHtml += '</div></div>';
                    }
                    
                    // Afficher le texte détecté
                    if (data.text && data.text.length > 0) {
                        detailsHtml += '<div style="margin-bottom: 15px;"><h5>Texte détecté:</h5><p>' + data.text + '</p></div>';
                    }
                    
                    detailsHtml += '</div>';
                    
                    // Mettre à jour le conteneur de résultats
                    document.getElementById('analysisDetails').innerHTML = detailsHtml;
                    
                    // Activer les boutons d'utilisation des descriptions
                    document.getElementById('usePositiveBtn').disabled = false;
                    document.getElementById('useNegativeBtn').disabled = false;
                    
                    // Afficher un message de succès
                    showToast('Image analysée avec succès', 'success');
                } else {
                    // Afficher un message d'erreur
                    resultContainer.innerHTML = `<div class="alert alert-danger" role="alert">Erreur: ${data.message}</div>`;
                    showToast('Erreur lors de l\'analyse de l\'image', 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                resultContainer.innerHTML = '<div class="alert alert-danger" role="alert">Une erreur s\'est produite lors de la communication avec le serveur.</div>';
                showToast('Erreur de communication avec le serveur', 'error');
            });
        }
        
        // Fonction pour utiliser la description d'image comme prompt
        function useImageDescription(type) {
            let description = '';
            
            if (type === 'positive') {
                const positiveDesc = document.getElementById('positiveDescription');
                if (positiveDesc && positiveDesc.value) {
                    description = positiveDesc.value;
                }
            } else if (type === 'negative') {
                const negativeDesc = document.getElementById('negativeDescription');
                if (negativeDesc && negativeDesc.value) {
                    description = negativeDesc.value;
                }
            }
            
            if (description) {
                // Mettre à jour le prompt dans l'interface
                let promptInput;
                if (type === 'positive') {
                    promptInput = document.getElementById('prompt');
                } else {
                    promptInput = document.getElementById('negative_prompt');
                }
                
                if (promptInput) {
                    promptInput.value = description;
                    // Déclencher un événement input pour mettre à jour tout ce qui dépend de cette valeur
                    promptInput.dispatchEvent(new Event('input'));
                    
                    // Faire défiler jusqu'à la section de génération d'image
                    const imageGenSection = document.getElementById('imageGeneration');
                    if (imageGenSection) {
                        imageGenSection.scrollIntoView({ behavior: 'smooth' });
                    }
                    
                    // Afficher un message de confirmation
                    showToast('Description utilisée comme prompt', 'success');
                } else {
                    showToast('Impossible de trouver le champ de prompt', 'error');
                }
            } else {
                showToast('Aucune description disponible', 'warning');
            }
        }

        // Fonction pour afficher des notifications toast
        function showToast(message, type = 'info') {
            // Créer l'élément toast s'il n'existe pas
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.position = 'fixed';
                toastContainer.style.bottom = '20px';
                toastContainer.style.right = '20px';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }
            
            // Créer le toast
            const toast = document.createElement('div');
            toast.style.minWidth = '250px';
            toast.style.margin = '10px';
            toast.style.padding = '15px';
            toast.style.borderRadius = '4px';
            toast.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            toast.style.transition = 'all 0.3s ease';
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(20px)';
            
            // Définir le style en fonction du type
            switch (type) {
                case 'success':
                    toast.style.backgroundColor = '#d4edda';
                    toast.style.color = '#155724';
                    toast.style.borderLeft = '5px solid #28a745';
                    break;
                case 'error':
                    toast.style.backgroundColor = '#f8d7da';
                    toast.style.color = '#721c24';
                    toast.style.borderLeft = '5px solid #dc3545';
                    break;
                case 'warning':
                    toast.style.backgroundColor = '#fff3cd';
                    toast.style.color = '#856404';
                    toast.style.borderLeft = '5px solid #ffc107';
                    break;
                default: // info
                    toast.style.backgroundColor = '#d1ecf1';
                    toast.style.color = '#0c5460';
                    toast.style.borderLeft = '5px solid #17a2b8';
            }
            
            // Ajouter le message
            toast.textContent = message;
            
            // Ajouter le toast au conteneur
            toastContainer.appendChild(toast);
            
            // Animation d'entrée
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            }, 10);
            
            // Supprimer le toast après 3 secondes
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Fonction pour changer d'onglet
        function switchTab(tabId) {
            // Masquer tous les contenus d'onglets
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Désactiver tous les boutons d'onglets
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Afficher le contenu de l'onglet sélectionné
            document.getElementById(tabId).classList.add('active');
            
            // Activer le bouton d'onglet correspondant
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
        }
        
        // Démarrer l'application en récupérant l'adresse du serveur
        document.addEventListener('DOMContentLoaded', function() {
            getServerAddress();
            
            // Configurer les gestionnaires d'événements pour les onglets
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });
            
            // Ajouter les gestionnaires d'événements après que l'interface soit chargée
            setTimeout(function() {
                // Gestionnaire pour le bouton d'ajout de LoRA
                const addLoraBtn = document.getElementById('addLoraBtn');
                if (addLoraBtn) {
                    addLoraBtn.addEventListener('click', addLoraFromInput);
                    console.log("Gestionnaire d'événement pour l'ajout de LoRA ajouté");
                }
                
                // Configurer les gestionnaires d'événements pour les éléments LoRA
                setupLoraItemListeners();
                
                // Gestionnaire pour le bouton de description d'image
                const describeImageBtn = document.getElementById('describeImageBtn');
                if (describeImageBtn) {
                    describeImageBtn.addEventListener('click', describeImageWithGoogleVision);
                    console.log("Gestionnaire d'événement pour la description d'image ajouté");
                }
                
                // Gestionnaire pour le bouton de sauvegarde de la clé API Google Vision
                const saveGoogleVisionKeyBtn = document.getElementById('saveGoogleVisionKeyBtn');
                if (saveGoogleVisionKeyBtn) {
                    saveGoogleVisionKeyBtn.addEventListener('click', saveGoogleVisionApiKey);
                    console.log("Gestionnaire d'événement pour la sauvegarde de la clé API Google Vision ajouté");
                }
                
                // Gestionnaire pour le bouton de téléchargement d'image
                const uploadButton = document.getElementById('uploadButton');
                const imageUpload = document.getElementById('imageUpload');
                if (uploadButton && imageUpload) {
                    uploadButton.addEventListener('click', function() {
                        imageUpload.click();
                    });
                    
                    imageUpload.addEventListener('change', function() {
                        if (this.files && this.files[0]) {
                            handleImageUpload(this.files[0]);
                        }
                    });
                }
                
                // Gestionnaire pour le bouton de suppression d'image
                const removeImageBtn = document.getElementById('removeImageBtn');
                if (removeImageBtn) {
                    removeImageBtn.addEventListener('click', removeSelectedImage);
                }
                
                // Gestionnaire pour le glisser-déposer d'image
                const dropZone = document.getElementById('dropZone');
                if (dropZone) {
                    // Empêcher le comportement par défaut du navigateur
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        dropZone.addEventListener(eventName, function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                        }, false);
                    });
                    
                    // Ajouter des effets visuels pendant le glisser-déposer
                    ['dragenter', 'dragover'].forEach(eventName => {
                        dropZone.addEventListener(eventName, function() {
                            this.style.backgroundColor = '#2a2a2a';
                            this.style.borderColor = '#7c3aed';
                        }, false);
                    });
                    
                    ['dragleave', 'drop'].forEach(eventName => {
                        dropZone.addEventListener(eventName, function() {
                            this.style.backgroundColor = '';
                            this.style.borderColor = '';
                        }, false);
                    });
                    
                    // Gérer le dépôt de fichier
                    dropZone.addEventListener('drop', function(e) {
                        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                            handleImageUpload(e.dataTransfer.files[0]);
                        }
                    }, false);
                }
                
                // Vérifier la configuration Google Vision
                checkGoogleVisionConfig();
                
                // Vérifier la configuration DeepSeek
                checkDeepSeekConfig();
                
                // Charger la liste des LoRAs depuis l'API
                loadLorasList();
                
                // Gestionnaire pour le bouton de génération de prompt
                const generatePromptBtn = document.getElementById('generatePromptBtn');
                if (generatePromptBtn) {
                    generatePromptBtn.addEventListener('click', generatePromptWithDeepSeek);
                    console.log("Gestionnaire d'événement pour la génération de prompt ajouté");
                }
                
                // Gestionnaire pour le bouton de sauvegarde de la clé API DeepSeek
                const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
                if (saveApiKeyBtn) {
                    saveApiKeyBtn.addEventListener('click', saveDeepSeekApiKey);
                    console.log("Gestionnaire d'événement pour la sauvegarde de la clé API DeepSeek ajouté");
                }
                
                // Gestionnaires pour la mise à jour de la prévisualisation
                const promptInstruction = document.getElementById('promptInstruction');
                const promptStyle = document.getElementById('promptStyle');
                const promptTheme = document.getElementById('promptTheme');
                const promptBackground = document.getElementById('promptBackground');
                
                if (promptInstruction) {
                    promptInstruction.addEventListener('input', updatePromptPreview);
                }
                
                if (promptStyle) {
                    promptStyle.addEventListener('change', updatePromptPreview);
                }
                
                if (promptTheme) {
                    promptTheme.addEventListener('change', updatePromptPreview);
                }
                
                if (promptBackground) {
                    promptBackground.addEventListener('change', updatePromptPreview);
                }
                
                // Gestionnaires pour les boutons d'utilisation des descriptions
                const usePositiveBtn = document.getElementById('usePositiveBtn');
                if (usePositiveBtn) {
                    usePositiveBtn.addEventListener('click', function() {
                        useImageDescription('positive');
                    });
                    console.log("Gestionnaire d'événement pour l'utilisation de la description positive ajouté");
                }
                
                const useNegativeBtn = document.getElementById('useNegativeBtn');
                if (useNegativeBtn) {
                    useNegativeBtn.addEventListener('click', function() {
                        useImageDescription('negative');
                    });
                    console.log("Gestionnaire d'événement pour l'utilisation de la description négative ajouté");
                }
                
                // Gestionnaire pour le bouton de redémarrage de ComfyUI
                const restartComfyUIBtn = document.getElementById('restartComfyUIBtn');
                if (restartComfyUIBtn) {
                    restartComfyUIBtn.addEventListener('click', restartComfyUI);
                    console.log("Gestionnaire d'événement pour le redémarrage de ComfyUI ajouté");
                }
                
                // Gestionnaire pour le bouton de connexion avec Google
                const googleLoginBtn = document.getElementById('googleLoginBtn');
                if (googleLoginBtn) {
                    googleLoginBtn.addEventListener('click', loginWithGoogle);
                    console.log("Gestionnaire d'événement pour la connexion avec Google ajouté");
                }
                
                // Gestionnaire pour le bouton de déconnexion
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', logout);
                    console.log("Gestionnaire d'événement pour la déconnexion ajouté");
                }
                
                // Gestionnaire pour le bouton d'enregistrement des utilisateurs autorisés
                const saveAuthorizedUsersBtn = document.getElementById('saveAuthorizedUsersBtn');
                if (saveAuthorizedUsersBtn) {
                    saveAuthorizedUsersBtn.addEventListener('click', saveAuthorizedUsers);
                    console.log("Gestionnaire d'événement pour l'enregistrement des utilisateurs autorisés ajouté");
                }
            }, 1000); // Attendre 1 seconde pour s'assurer que l'interface est chargée
        });

        // Fonction pour charger les images existantes
        function loadImages() {
            // Récupérer le nombre d'images par défaut
            const numImages = 3;
            
            console.log(`Chargement des ${numImages} dernières images...`);
            
            // Récupérer la liste des images
            fetch(`${serverAddress}/list_images?num_images=${numImages}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Images chargées:", data);
                    
                    // Afficher les images si elles existent
                    if (data.image_urls && data.image_urls.length > 0) {
                        refreshImages();
                    }
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des images:', error);
                });
        }
        
        // Fonction pour charger la liste des LoRAs depuis l'API
        function loadLorasList() {
            console.log(`Chargement de la liste des LoRAs depuis ${serverAddress}/list_loras...`);
            
            // Récupérer le conteneur de la liste des LoRAs
            const lorasListContainer = document.getElementById('lorasList');
            if (!lorasListContainer) {
                console.error("Conteneur de la liste des LoRAs non trouvé");
                return;
            }
            
            // Afficher un indicateur de chargement
            lorasListContainer.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 20px;">
                    <div class="loading-spinner" style="display: inline-block;"></div>
                    <p style="margin-top: 10px; color: #888;">Chargement des LoRAs...</p>
                </div>
            `;
            
            fetch(`${serverAddress}/list_loras`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("LoRAs chargés:", data);
                    
                    if (data.loras && data.loras.length > 0) {
                        // Vider le conteneur
                        lorasListContainer.innerHTML = '';
                        
                        // Ajouter chaque LoRA à la liste
                        data.loras.forEach(lora => {
                            const loraItem = document.createElement('div');
                            loraItem.className = 'lora-item';
                            loraItem.textContent = lora;
                            
                            // Ajouter un gestionnaire d'événements de clic
                            loraItem.addEventListener('click', function() {
                                fillLoraInput(lora);
                            });
                            
                            lorasListContainer.appendChild(loraItem);
                        });
                        
                        console.log(`${data.loras.length} LoRAs affichés`);
                        showToast(`${data.loras.length} LoRAs chargés`, "success");
                    } else {
                        // Aucun LoRA trouvé
                        lorasListContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #888;">Aucun LoRA disponible</div>';
                        console.log("Aucun LoRA trouvé");
                    }
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des LoRAs:', error);
                    
                    // Afficher un message d'erreur
                    lorasListContainer.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #dc3545;">
                            Erreur lors du chargement des LoRAs: ${error.message}
                            <button onclick="loadLorasList()" style="display: block; margin: 10px auto; padding: 5px 10px; background-color: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer;">Réessayer</button>
                        </div>
                    `;
                    
                    showToast(`Erreur lors du chargement des LoRAs: ${error.message}`, "error");
                });
        }

        // Fonction pour vérifier la configuration DeepSeek
        function checkDeepSeekConfig() {
            fetch(`${serverAddress}/check_config`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        const apiKeyStatus = document.getElementById('apiKeyStatus');
                        if (data.config.deepseek_api_key_configured) {
                            apiKeyStatus.textContent = "✅ Clé API DeepSeek configurée";
                            apiKeyStatus.style.color = "#28a745";
                            
                            // Activer le bouton de génération de prompt
                            document.getElementById('generatePromptBtn').disabled = false;
                        } else {
                            apiKeyStatus.textContent = "❌ Clé API DeepSeek non configurée";
                            apiKeyStatus.style.color = "#dc3545";
                            
                            // Désactiver le bouton de génération de prompt
                            document.getElementById('generatePromptBtn').disabled = true;
                        }
                    }
                })
                .catch(error => {
                    console.error("Erreur lors de la vérification de la configuration DeepSeek:", error);
                });
        }
        
        // Fonction pour sauvegarder la clé API DeepSeek
        function saveDeepSeekApiKey() {
            const apiKey = document.getElementById('deepSeekApiKey').value.trim();
            
            if (!apiKey) {
                alert("Veuillez entrer une clé API DeepSeek valide.");
                return;
            }
            
            // Désactiver le bouton pendant la sauvegarde
            const saveBtn = document.getElementById('saveApiKeyBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = "Sauvegarde...";
            
            // Mettre à jour le statut
            const apiKeyStatus = document.getElementById('apiKeyStatus');
            apiKeyStatus.textContent = "Sauvegarde en cours...";
            apiKeyStatus.style.color = "#7c3aed";
            
            // Envoyer la requête pour mettre à jour la clé API
            fetch(`${serverAddress}/update_deepseek_key`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    api_key: apiKey
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Réactiver le bouton
                saveBtn.disabled = false;
                saveBtn.textContent = "Enregistrer";
                
                if (data.status === 'success') {
                    // Mettre à jour le statut
                    apiKeyStatus.textContent = "✅ Clé API DeepSeek sauvegardée avec succès";
                    apiKeyStatus.style.color = "#28a745";
                    
                    // Effacer le champ de saisie
                    document.getElementById('deepSeekApiKey').value = "";
                    
                    // Vérifier la configuration pour mettre à jour l'interface
                    setTimeout(checkDeepSeekConfig, 1000);
                } else {
                    // Afficher l'erreur
                    apiKeyStatus.textContent = `❌ Erreur: ${data.message}`;
                    apiKeyStatus.style.color = "#dc3545";
                }
            })
            .catch(error => {
                // Réactiver le bouton
                saveBtn.disabled = false;
                saveBtn.textContent = "Enregistrer";
                
                // Afficher l'erreur
                apiKeyStatus.textContent = `❌ Erreur: ${error.message}`;
                apiKeyStatus.style.color = "#dc3545";
                
                console.error("Erreur lors de la sauvegarde de la clé API DeepSeek:", error);
            });
        }
        
        // Fonction pour mettre à jour l'aperçu du prompt
        function updatePromptPreview() {
            const instruction = document.getElementById('promptInstruction').value.trim();
            const style = document.getElementById('promptStyle').value;
            const theme = document.getElementById('promptTheme').value;
            const background = document.getElementById('promptBackground').value;
            
            let preview = instruction;
            
            // Ajouter le style s'il est sélectionné
            if (style) {
                preview += `, style: ${style}`;
            }
            
            // Ajouter le thème s'il est sélectionné
            if (theme) {
                preview += `, thème: ${theme}`;
            }
            
            // Ajouter l'arrière-plan s'il est sélectionné
            if (background) {
                preview += `, arrière-plan: ${background}`;
            }
            
            // Mettre à jour l'aperçu
            const previewElement = document.getElementById('promptPreview');
            if (preview.trim()) {
                previewElement.textContent = preview;
            } else {
                previewElement.textContent = "L'aperçu du prompt apparaîtra ici...";
            }
        }
        
        // Fonction pour configurer les gestionnaires d'événements pour les éléments LoRA
        function setupLoraItemListeners() {
            // Sélectionner tous les éléments avec la classe lora-item
            const loraItems = document.querySelectorAll('.lora-item');
            
            // Pour chaque élément, supprimer l'attribut onclick et ajouter un écouteur d'événements
            loraItems.forEach(item => {
                // Récupérer le nom du LoRA à partir du texte de l'élément
                const loraName = item.textContent;
                
                // Supprimer l'attribut onclick existant
                item.removeAttribute('onclick');
                
                // Ajouter un écouteur d'événements de clic
                item.addEventListener('click', function() {
                    fillLoraInput(loraName);
                });
            });
            
            console.log(`Gestionnaires d'événements configurés pour ${loraItems.length} éléments LoRA`);
        }
        
        // Fonction pour redémarrer ComfyUI
        function restartComfyUI() {
            // Mettre à jour le statut
            const restartStatus = document.getElementById('restartStatus');
            restartStatus.textContent = "Redémarrage en cours...";
            restartStatus.style.color = "#7c3aed";
            
            // Désactiver le bouton pendant le redémarrage
            const restartBtn = document.getElementById('restartComfyUIBtn');
            restartBtn.disabled = true;
            restartBtn.textContent = "Redémarrage en cours...";
            
            // Afficher un toast
            showToast("Redémarrage de ComfyUI en cours...", "info");
            
            // Envoyer la requête au serveur
            fetch(`${serverAddress}/restart_comfyui`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Réactiver le bouton
                restartBtn.disabled = false;
                restartBtn.textContent = "Redémarrer ComfyUI";
                
                if (data.status === 'success') {
                    // Mettre à jour le statut
                    restartStatus.textContent = "✅ ComfyUI redémarré avec succès";
                    restartStatus.style.color = "#28a745";
                    
                    // Afficher un toast de succès
                    showToast("ComfyUI redémarré avec succès", "success");
                    
                    // Après 30 secondes, vérifier si le serveur est accessible
                    setTimeout(() => {
                        checkComfyUIStatus();
                    }, 30000);
                } else {
                    // Afficher l'erreur
                    restartStatus.textContent = `❌ Erreur: ${data.message}`;
                    restartStatus.style.color = "#dc3545";
                    
                    // Afficher un toast d'erreur
                    showToast(`Erreur lors du redémarrage de ComfyUI: ${data.message}`, "error");
                }
            })
            .catch(error => {
                // Réactiver le bouton
                restartBtn.disabled = false;
                restartBtn.textContent = "Redémarrer ComfyUI";
                
                // Afficher l'erreur
                restartStatus.textContent = `❌ Erreur: ${error.message}`;
                restartStatus.style.color = "#dc3545";
                
                // Afficher un toast d'erreur
                showToast(`Erreur lors du redémarrage de ComfyUI: ${error.message}`, "error");
                
                console.error("Erreur lors du redémarrage de ComfyUI:", error);
            });
        }
        
        // Fonction pour vérifier si ComfyUI est accessible
        function checkComfyUIStatus() {
            const restartStatus = document.getElementById('restartStatus');
            restartStatus.textContent = "Vérification de l'état de ComfyUI...";
            restartStatus.style.color = "#7c3aed";
            
            // Vérifier si le serveur ComfyUI est accessible
            fetch(`http://127.0.0.1:8188/system_stats`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // ComfyUI est accessible
                    restartStatus.textContent = "✅ ComfyUI est en ligne et fonctionne correctement";
                    restartStatus.style.color = "#28a745";
                    
                    // Afficher un toast de succès
                    showToast("ComfyUI est en ligne et fonctionne correctement", "success");
                })
                .catch(error => {
                    // ComfyUI n'est pas accessible
                    restartStatus.textContent = "⚠️ ComfyUI pourrait ne pas être complètement démarré. Veuillez patienter...";
                    restartStatus.style.color = "#ffc107";
                    
                    // Réessayer après 30 secondes
                    setTimeout(() => {
                        checkComfyUIStatus();
                    }, 30000);
                });
        }

        // Fonction pour vérifier l'état de l'authentification
        function checkAuthStatus() {
            console.log("Vérification de l'état d'authentification...");
            
            // D'abord, vérifier si les identifiants OAuth sont valides
            fetch(`${serverAddress}/check_config`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(configData => {
                    console.log("Configuration:", configData);
                    
                    // Vérifier si les identifiants OAuth sont valides
                    if (!configData.config.oauth_credentials_valid) {
                        // Afficher un message d'erreur
                        document.getElementById('initialLoading').style.display = 'none';
                        document.getElementById('loginScreen').style.display = 'block';
                        document.querySelector('.container').style.display = 'none';
                        
                        // Mettre à jour le message de connexion
                        const loginMessage = document.querySelector('#loginScreen p');
                        if (loginMessage) {
                            loginMessage.innerHTML = "L'authentification Google n'est pas correctement configurée. Veuillez configurer des identifiants OAuth valides dans le fichier config.json.";
                            loginMessage.style.color = "#dc3545";
                        }
                        
                        // Désactiver le bouton de connexion
                        const loginButton = document.getElementById('googleLoginBtn');
                        if (loginButton) {
                            loginButton.disabled = true;
                            loginButton.style.opacity = "0.5";
                            loginButton.style.cursor = "not-allowed";
                        }
                        
                        console.error("Identifiants OAuth non valides");
                        return;
                    }
                    
                    // Ensuite, vérifier l'état de l'authentification
                    return fetch(`${serverAddress}/auth_status`);
                })
                .then(response => {
                    if (!response) return; // Si la première promesse a retourné early
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return; // Si la première promesse a retourné early
                    
                    console.log("Réponse de auth_status:", data);
                    
                    if (data.authenticated) {
                        // L'utilisateur est authentifié
                        currentUser = data.user;
                        console.log("Utilisateur authentifié:", currentUser);
                        
                        // Vérifier si l'utilisateur est autorisé
                        if (data.authorized === false) {
                            // L'utilisateur n'est pas autorisé
                            document.getElementById('initialLoading').style.display = 'none';
                            document.getElementById('loginScreen').style.display = 'block';
                            document.querySelector('.container').style.display = 'none';
                            
                            // Mettre à jour le message de connexion
                            const loginMessage = document.querySelector('#loginScreen p');
                            if (loginMessage) {
                                loginMessage.innerHTML = "Vous n'êtes pas autorisé à accéder à cette application. Veuillez contacter l'administrateur.";
                                loginMessage.style.color = "#dc3545";
                            }
                            
                            console.error("Utilisateur non autorisé");
                            return;
                        }
                        
                        // Vérifier si l'utilisateur est administrateur
                        checkIfAdmin();
                        
                        // Afficher l'interface principale
                        document.getElementById('initialLoading').style.display = 'none';
                        document.getElementById('loginScreen').style.display = 'none';
                        document.querySelector('.container').style.display = 'block';
                        
                        // Mettre à jour les informations du compte
                        updateAccountInfo();
                        
                        // Charger les données nécessaires
                        checkDeepSeekConfig();
                        checkGoogleVisionConfig();
                        loadLorasList();
                        loadImages();
                    } else {
                        // L'utilisateur n'est pas authentifié
                        document.getElementById('initialLoading').style.display = 'none';
                        document.getElementById('loginScreen').style.display = 'block';
                        document.querySelector('.container').style.display = 'none';
                        console.log("Utilisateur non authentifié");
                        
                        // Activer le bouton de connexion
                        const loginButton = document.getElementById('googleLoginBtn');
                        if (loginButton) {
                            loginButton.disabled = false;
                            loginButton.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="margin-right: 10px;">
                                    <path fill="#ffffff" d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/>
                                </svg>
                                Se connecter avec Google
                            `;
                        }
                    }
                })
                .catch(error => {
                    console.error("Erreur lors de la vérification de l'authentification:", error);
                    
                    // Afficher un message d'erreur
                    document.getElementById('initialLoading').style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'block';
                    document.querySelector('.container').style.display = 'none';
                    
                    // Mettre à jour le message de connexion
                    const loginMessage = document.querySelector('#loginScreen p');
                    if (loginMessage) {
                        loginMessage.innerHTML = `Erreur lors de la vérification de l'authentification: ${error.message}`;
                        loginMessage.style.color = "#dc3545";
                    }
                });
        }
        
        // Fonction pour vérifier si l'utilisateur est administrateur
        function checkIfAdmin() {
            fetch(`${serverAddress}/check_config`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.config.authorized_users_configured) {
                        // Récupérer la liste des utilisateurs autorisés
                        fetch(`${serverAddress}/auth_status`)
                            .then(response => response.json())
                            .then(authData => {
                                if (authData.authenticated) {
                                    // Vérifier si l'utilisateur est le premier de la liste (administrateur)
                                    isAdmin = true; // Temporairement, considérer tous les utilisateurs comme administrateurs
                                    
                                    // Afficher le panneau d'administration si l'utilisateur est administrateur
                                    if (isAdmin) {
                                        document.getElementById('adminPanel').style.display = 'block';
                                        
                                        // Charger la liste des utilisateurs autorisés
                                        loadAuthorizedUsers();
                                    }
                                }
                            });
                    }
                })
                .catch(error => {
                    console.error("Erreur lors de la vérification des droits d'administration:", error);
                });
        }
        
        // Fonction pour mettre à jour les informations du compte
        function updateAccountInfo() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.name || 'Utilisateur';
                document.getElementById('userEmail').textContent = currentUser.email || '';
                
                if (currentUser.picture) {
                    document.getElementById('userPicture').src = currentUser.picture;
                }
            }
        }
        
        // Fonction pour se connecter avec Google
        function loginWithGoogle() {
            console.log("Tentative de connexion avec Google...");
            
            // Afficher un indicateur de chargement
            const loginBtn = document.getElementById('googleLoginBtn');
            if (loginBtn) {
                loginBtn.disabled = true;
                loginBtn.innerHTML = `
                    <div style="width: 20px; height: 20px; border: 3px solid #ffffff; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;"></div>
                    Connexion en cours...
                `;
            }
            
            // Rediriger vers la page de connexion
            window.location.href = `${serverAddress}/login`;
        }
        
        // Fonction pour se déconnecter
        function logout() {
            window.location.href = `${serverAddress}/logout`;
        }
        
        // Fonction pour charger la liste des utilisateurs autorisés
        function loadAuthorizedUsers() {
            fetch(`${serverAddress}/check_config`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.config.authorized_users_configured) {
                        // Pour l'instant, nous n'avons pas d'API pour récupérer la liste des utilisateurs autorisés
                        // Donc nous laissons le champ vide pour que l'administrateur puisse le remplir
                    }
                })
                .catch(error => {
                    console.error("Erreur lors du chargement des utilisateurs autorisés:", error);
                });
        }
        
        // Fonction pour enregistrer la liste des utilisateurs autorisés
        function saveAuthorizedUsers() {
            const authorizedUsersText = document.getElementById('authorizedUsers').value;
            const authorizedUsers = authorizedUsersText.split('\n')
                .map(email => email.trim())
                .filter(email => email !== '');
            
            // Mettre à jour le statut
            const statusElement = document.getElementById('authorizedUsersStatus');
            statusElement.textContent = "Enregistrement en cours...";
            statusElement.style.color = "#7c3aed";
            
            // Désactiver le bouton pendant l'enregistrement
            const saveBtn = document.getElementById('saveAuthorizedUsersBtn');
            saveBtn.disabled = true;
            
            // Envoyer la requête au serveur
            fetch(`${serverAddress}/update_authorized_users`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    users: authorizedUsers
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Réactiver le bouton
                saveBtn.disabled = false;
                
                if (data.status === 'success') {
                    // Mettre à jour le statut
                    statusElement.textContent = "✅ Liste des utilisateurs autorisés mise à jour avec succès";
                    statusElement.style.color = "#28a745";
                    
                    // Afficher un toast de succès
                    showToast("Liste des utilisateurs autorisés mise à jour avec succès", "success");
                } else {
                    // Afficher l'erreur
                    statusElement.textContent = `❌ Erreur: ${data.message}`;
                    statusElement.style.color = "#dc3545";
                    
                    // Afficher un toast d'erreur
                    showToast(`Erreur: ${data.message}`, "error");
                }
            })
            .catch(error => {
                // Réactiver le bouton
                saveBtn.disabled = false;
                
                // Afficher l'erreur
                statusElement.textContent = `❌ Erreur: ${error.message}`;
                statusElement.style.color = "#dc3545";
                
                // Afficher un toast d'erreur
                showToast(`Erreur: ${error.message}`, "error");
                
                console.error("Erreur lors de l'enregistrement des utilisateurs autorisés:", error);
                });
        }
    </script>
</body>
</html>
